---
title: "DSAN 5100 IPEDS Data Cleaning"
author: "Taylor McDermott"
format: 
  html:
    embed-resources: true
    code-fold: true
editor: visual
toc: true
jupyter: python3
---

# Clean IPEDS Data - Gender and Ethnicity

```{python}

# Import required Python packages
import pandas as pd
import numpy as np
import os
import openpyxl
import glob

# Read data
enrollment_2024 = pd.read_csv("../data/ipeds_demographics/EFFY2024.csv")
enrollment_2023 = pd.read_csv("../data/ipeds_demographics/EFFY2023.csv")
enrollment_2022 = pd.read_csv("../data/ipeds_demographics/EFFY2022.csv")
enrollment_2021 = pd.read_csv("../data/ipeds_demographics/EFFY2021.csv")
enrollment_2020 = pd.read_csv("../data/ipeds_demographics/EFFY2020.csv")
enrollment_2019 = pd.read_csv("../data/ipeds_demographics/EFFY2019.csv", encoding_errors="ignore")
enrollment_2018 = pd.read_csv("../data/ipeds_demographics/EFFY2018.csv", encoding_errors="ignore")

enrollment_col_dict = pd.read_excel("../data/ipeds_demographics/EFFY2024_dict.xlsx", sheet_name="Varlist")
student_degree_type = pd.read_excel("../data/ipeds_demographics/EFFY2024_dict.xlsx", sheet_name="Frequencies")
#institution_characteristics = pd.read_csv("../data/ipeds_demographics/HD2024.csv")
institution_characteristics_dict = pd.read_excel("../data/ipeds_demographics/HD2024_dict.xlsx", sheet_name="Frequencies")
state_names = pd.read_csv("../data/ipeds_demographics/data-map-state-abbreviations.csv")

# Combine and dedup institution_characteristics so every school is covered (even if it no longer exists)
path = "../data/ipeds_demographics/institution_characteristics"
# Get all .csv files in the folder
csv_files = glob.glob(os.path.join(path, "*.csv"))
# Read and concatenate
dfs = []
for f in csv_files:
    year = os.path.splitext(os.path.basename(f))[0][-4:]   # last 4 digits of filename
    df = pd.read_csv(f, encoding="utf-8", encoding_errors="ignore")
    df["year"] = year
    dfs.append(df)
institution_characteristics = pd.concat(dfs, ignore_index=True)
# Sort by year
institution_characteristics = institution_characteristics.sort_values(by=["year", "state"], ascending=[False, True])
# Isolate specific columns
institution_characteristics = institution_characteristics[["unitid", "institution_name", "state", "HLOFFER"]]
# Dedup, with 2024 as the most recent copy
institution_characteristics = institution_characteristics.drop_duplicates(subset=["unitid"])

# Create a dictionary with the enrollment dataframes by year
enrollment_dfs = {"2024": enrollment_2024,
                  "2023": enrollment_2023,
                  "2022": enrollment_2022,
                  "2021": enrollment_2021,
                  "2020": enrollment_2020,
                  "2019": enrollment_2019,
                  "2018": enrollment_2018
                  }

# Create two dictionaries to map degree type and institution type
  # Ex: 2 = Undergraduate, 11 = Non-degree/certificate-seeking
effylev_map = student_degree_type[student_degree_type["VarName"] == "EFFYLEV"]
effylev_map = effylev_map[["CodeValue", "ValueLabel"]]
effylev_map = effylev_map.set_index("CodeValue")["ValueLabel"].to_dict()

effyalev_map = student_degree_type[student_degree_type["VarName"] == "EFFYALEV"]
effyalev_map = effyalev_map[["CodeValue", "ValueLabel"]]
effyalev_map = effyalev_map.set_index("CodeValue")["ValueLabel"].to_dict()

# Create a dictionary to map highest offering level contextual information
hloffer_map = institution_characteristics_dict[institution_characteristics_dict["VarName"] == "HLOFFER"]
hloffer_map = hloffer_map[["CodeValue", "ValueLabel"]]
hloffer_map["CodeValue"] = pd.to_numeric(hloffer_map["CodeValue"], errors="coerce").astype("Int64")
hloffer_map = hloffer_map.set_index("CodeValue")["ValueLabel"].to_dict()

# Create a dictionary from the "varName" and "varTitle" columns enrollment_dict
enrollment_col_dict = enrollment_col_dict[["varName", "varTitle"]]
col_rename_dict = enrollment_col_dict.set_index("varName")["varTitle"].to_dict()

# Prep institution information enrichment: state names
state_names = state_names.set_index("abbreviation")["state"].to_dict()
institution_characteristics["state_fips_code"] = institution_characteristics["state"].copy() 
institution_characteristics["state"] = institution_characteristics["state"].map(state_names)

# Pull institutional characteristics that would be helpful to include in this table
institution_characteristics.columns = institution_characteristics.columns.str.strip()
institution_characteristics["unitid"] = institution_characteristics["unitid"].astype(int)

# Create an empty dataframe to combine all the demographics data
ipeds_demographic_data = pd.DataFrame()

'''
Remap the following:
- Degree type codes to human-understandable degree type values
- Shortened column names to human-understandable demographics categories
- Get UNITID info from institutional characteristics
'''
for year, df in enrollment_dfs.items():

  df["year"] = year

  # Map the full value names
  if "EFFYLEV" in df.columns:
    df["EFFYLEV"] = df["EFFYLEV"].map(effylev_map)
  if "EFFYALEV" in df.columns:
    df["EFFYALEV"] = df["EFFYALEV"].map(effyalev_map)

  # Rename columns
  df.rename(columns=col_rename_dict, inplace=True)

  # Rename institution ID back to UNITID for consistency
  df.rename(columns={"Unique identification number of the institution": "unitid"}, inplace=True)
  pd.set_option('display.max_columns', None)

  # Make sure columns match before concat
  df.columns = df.columns.str.strip()
  df["unitid"] = df["unitid"].astype(int)

  # Combine institution characteristics with demographic data
  df = df.set_index("unitid").join(institution_characteristics.set_index("unitid"))
  df = df.reset_index()

  # Goal is to replace "." with np.nan, not working as intended
  cols = [
    "Gender unknown",
    "Another gender",
    "Total of gender unknown and another gender",
    "Total gender reported as one of the mutually exclusive binary categories (Men/Women)"
  ]
  # Keep the columns that are actually in the current dataframe
  cols = [c for c in cols if c in df.columns]
  df[cols] = df[cols].astype(str)
  # Replace "." (or any variations) with np.nan
  df[cols] = df[cols].replace(r"^\s*\.\s*$", np.nan, regex=True)
  # Type conversion for sum at state level
  df[cols] = df[cols].astype(float).astype("Int64")

  # Add trade school filtering information based on the highest degree offered
  df["trade_school_check"] =  np.where(df["HLOFFER"].isin([1, 2, 3, 4]), True, False)

  # Map highest level offered to string value
  df["HLOFFER_original"] = df["HLOFFER"].copy()
  df["HLOFFER"] = pd.to_numeric(df["HLOFFER"], errors="coerce").astype("Int64")
  # print(df[["unitid", "HLOFFER"]].head())
  df["HLOFFER"] = df["HLOFFER"].map(hloffer_map)

  # Reorder columns for clarity
  cols_to_move = ["year", "institution_name", "state", "state_fips_code", "trade_school_check", "HLOFFER"]
  target = "Undergraduate or graduate level of student"
  # Pop the columns
  popped = [df.pop(c) for c in cols_to_move]
  # Insert after the target column
  insert_at = df.columns.get_loc(target) + 1
  for i, c in enumerate(cols_to_move):
      df.insert(insert_at + i, c, popped[i])

  # Combine the current year with the prior years
  ipeds_demographic_data = pd.concat([ipeds_demographic_data, df])

# Filter for the most relevant columns (drop imputation type values)
ipeds_demographic_data = ipeds_demographic_data.drop(ipeds_demographic_data.filter(regex=r"^(XEY|XEFY)").columns, axis=1)

# Create a copy of just 2024 data (the most recent year) for EDA
ipeds_demographic_data_2024 = ipeds_demographic_data[ipeds_demographic_data["year"] == "2024"]

# Create a copy of all the years filtered for undergraduate total enrollment (non-trade school) and total trade school enrollment (trade schools)
ipeds_demographic_data = ipeds_demographic_data[
  ((ipeds_demographic_data["trade_school_check"] == False) & (ipeds_demographic_data["Level and degree/certificate-seeking status of student"] == "Undergraduate total")) | 
  ((ipeds_demographic_data["trade_school_check"] == True) & (ipeds_demographic_data["Level and degree/certificate-seeking status of student"] == "All students total"))]

# Export all cleaned data to csv
ipeds_demographic_data.to_csv(f"../Cleaned data/Cleaned_ipeds_state_demographics.csv", index=False)
ipeds_demographic_data_2024.to_csv(f"../Cleaned data/Cleaned_ipeds_state_demographics_2024.csv", index=False)

```

# Transform IPEDS demographic data - state-level groups
```{python}

# Group by state and by year, using “All Students Total” in column “Level and degree/certificate-seeking status of student” for trade schools and "Undergraduate total" for non-trade schools to avoid duplicating counts across trade school and 4-year programs

state_demographics_summary = ipeds_demographic_data.copy()

# Drop institution-specific columns
state_demographics_summary = state_demographics_summary.drop(columns=["unitid", "institution_name", "HLOFFER", "Original level of study on survey form", "HLOFFER_original", "EFYGUKN"])

# Sum the different totals by demographics by state
state_demographics_summary = state_demographics_summary.groupby(by=["state", "state_fips_code", "year", "trade_school_check", "Level and degree/certificate-seeking status of student", "Undergraduate or graduate level of student"]).sum()
state_demographics_summary = state_demographics_summary.reset_index()

# Total sum by state
state_demographics_summary_totals = state_demographics_summary.copy()
state_demographics_summary_totals = state_demographics_summary_totals.groupby(by=["state", "state_fips_code", "year"]).sum()
state_demographics_summary_totals = state_demographics_summary_totals.reset_index()

# Isolate the 2024 summary data
state_demographics_summary_2024 = state_demographics_summary.copy()
state_demographics_summary_2024 = state_demographics_summary_2024[state_demographics_summary_2024["year"] == "2024"]

# Export all cleaned data to csv
state_demographics_summary.to_csv(f"../Cleaned data/Cleaned_ipeds_summary_state_demographics.csv", index=False)
state_demographics_summary_totals.to_csv(f"../Cleaned data/Cleaned_ipeds_totals_summary_state_demographics.csv", index=False)
state_demographics_summary_2024.to_csv(f"../Cleaned data/Cleaned_ipeds_summary_2024_state_demographics.csv", index=False)

```