---
title: "DSAN 5100 Student loans and debts EDA and visuals"
author: "Jen Guo"
format: 
  html:
    embed-resources: true
    code-fold: true
editor: visual
toc: true
---

# EDA debt data

```{r}
library(dplyr)
library(tidyverse)
#load the the cleaned debt by year data 
clean_debtyear <- read.csv("Cleaned data/Cleaned_debt_by_year.csv")
#head(clean_debtyear)

#create column to get sum dollars outstanding by year, quarter
clean_debtyear_outstanding_total <- clean_debtyear %>%
    group_by(Year) %>%
    mutate(Total_Dollars_Outstanding = rowSums(across(c("Less_than_5k_Dollars_Outstanding_.in.billions.", "X5k_to_10K_Dollars_Outstanding_.in.billions.", "X10k_to_20K_Dollars_Outstanding_.in.billions.", "X20k_to_40K_Dollars_Outstanding_.in.billions.", "X40k_to_60K_Dollars_Outstanding_.in.billions.", "X60k_to_80K_Dollars_Outstanding_.in.billions.", "X80k_to_100K_Dollars_Outstanding_.in.billions.", "X100k_to_200K_Dollars_Outstanding_.in.billions.", "X200K_plus_Dollars_Outstanding_.in.billions."))))
#head(clean_debtyear_outstanding_total$Total_Dollars_Outstanding)

#create column to get sum dollars borrowed by year, quarter
clean_debtyear_borrow_total <- clean_debtyear_outstanding_total %>%
    group_by(Year) %>%
    mutate(Total_Dollars_Borrowers = rowSums(across(c("Less_than_5k_Borrowers_.in.thousands.", "X5k_to_10k_Borrowers_.in.thousands.", "X10k_to_20k_Borrowers_.in.thousands.", "X20k_to_40k_Borrowers_.in.thousands.", "X40k_to_60k_Borrowers_.in.thousands." , "X60k_to_80k_Borrowers_.in.thousands." , "X80k_to_100k_Borrowers_.in.thousands.", "X100k_to_200k_Borrowers_.in.thousands.", "X200k_plus_Borrowers_.in.thousands." ))))
#head(clean_debtyear_borrow_total$Total_Dollars_Borrowers)
```

```{r}
#drop last two rows due to foot notes
clean_debtyear_drop <- head(clean_debtyear_borrow_total, n = -2)
#print(clean_debtyear_drop$Total_Dollars_Borrowers)
```

```{r}
#transform Year into Date format 
clean_debtyear_drop$Year <- as.numeric(clean_debtyear_drop$Year)

#ungroup by year 
clean_debtyear_drop <- dplyr::ungroup(clean_debtyear_drop)

#create plotly line graph of debt dolloars outstanding over years
library(plotly)
debtyear_fig <- plot_ly(clean_debtyear_drop,
                       x=~Year, y =~Total_Dollars_Outstanding, 
                       type = 'scatter',
                       mode = 'lines+markers',
                       text = ~paste("Year: ", Year, "<br>", "Quarter: ", Quarter, "<br>", "Total debt dollars outstanding: ", Total_Dollars_Outstanding), hoverinfo = "text", textposition = "none")

#add plot title and axis 
debtyear_fig <- debtyear_fig %>%
    layout(title = "Total Debt Dollars Outstanding from 2017 to 2025",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Debt Dollars Outstanding (in billions)"))

debtyear_fig
```

```{r}
#create plotly line graph of debt borrowers over years
debtyear_fig2 <- plot_ly(clean_debtyear_drop,
                       x=~Year, y =~Total_Dollars_Borrowers, 
                       type = 'scatter',
                       mode = 'lines+markers',
                       text = ~paste("Year: ", Year, "<br>", "Quarter: ", Quarter, "<br>", "Number of borrowers (in thousands): ", Total_Dollars_Borrowers), hoverinfo = "text", textposition = "none")

#add plot title and axis 
debtyear_fig2 <- debtyear_fig2 %>%
    layout(title = "Total Number of Loan Borrowers from 2017 to 2025",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Number of Borrowers (in thousands)"))

debtyear_fig2
```

# EDA Loan Type Data

```{r}
#load the the cleaned loan type by year data 
clean_loanyear <- read.csv("Cleaned data/Cleaned_loantype_year.csv")
#names(clean_loanyear)

#create column to get sum dollars loan outstanding by year
clean_loanyear_outstanding_total <- clean_loanyear %>%
    group_by(Year) %>%
    mutate(Total_Dollars_Loan_Outstanding = rowSums(across(c("Stafford_Subsidized_Dollars_Outstanding_.in.billions.", "Stafford_Unsubsidized_Dollars_Outstanding_.in.billions.", "Stafford_.Combined._Dollars_Outstanding_.in.billions.", "Grad_PLUS_Dollars_Outstanding_.in.billions.", "Parent_PLUS_Dollars_Outstanding_.in.billions.", "Perkins_Dollars_Outstanding_.in.billions." , "Consolidation_Dollars_Outstanding_.in.billions."))))

#create column for total reciever of loans by year 
clean_loanyear_recipients_total <- clean_loanyear_outstanding_total %>%
    group_by(Year) %>%
    mutate(Total_Loan_Recipients = rowSums(across(c("Stafford_Subsidized_Recipients_.in.millions.", "Stafford_Unsubsidized_Recipients_.in.millions.", "Stafford_.Combined._Unique_Recipients_.in.millions.", "Grad_PLUS_Recipients_.in.millions.", "Parent_PLUS_Recipients_.in.millions.", "Perkins_Recipients_.in.millions." , "Consolidation_Recipients_.in.millions."))))
                                                           
```

```{r}
#drop last 6 rows due to footnotes
clean_loanyear_drop <- head(clean_loanyear_recipients_total, n = -6)
```

```{r}
#transform Year into numeric format 
clean_loanyear_drop$Year <- as.numeric(clean_loanyear_drop$Year)

#ungroup by year 
clean_loanyear_drop <- dplyr::ungroup(clean_loanyear_drop)

#create plotly line graph of loan dolloars outstanding over years
loanyear_fig <- plot_ly(clean_loanyear_drop,
                       x=~Year, y =~Total_Dollars_Loan_Outstanding, 
                       type = 'scatter',
                       mode = 'lines+markers',
                       text = ~paste("Year: ", Year, "<br>", "Quarter: ", Quarter, "<br>", "Total loan dollars outstanding: ", Total_Dollars_Loan_Outstanding), hoverinfo = "text", textposition = "none")

#add plot title and axis 
loanyear_fig <- loanyear_fig %>%
    layout(title = "Total Loan Dollars Outstanding from 2014 to 2025",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Loan Dollars Outstanding (in billions)"))

loanyear_fig
```

```{r}
#create plotly line graph of loans recieved over years
loanyear_fig2 <- plot_ly(clean_loanyear_drop,
                       x=~Year, y =~Total_Loan_Recipients, 
                       type = 'scatter',
                       mode = 'lines+markers',
                       text = ~paste("Year: ", Year, "<br>", "Quarter: ", Quarter, "<br>", "Total recieved: ", Total_Loan_Recipients), hoverinfo = "text", textposition = "none")

#add plot title and axis 
loanyear_fig2 <- loanyear_fig2 %>%
    layout(title = "Total Number of Loans Recieved from 2014 to 2025",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Total Loans Recieved (in thousands)"))

loanyear_fig2
```

# IPEDS Tuition

```{r}
#load the tuition data 
tuition <- read.csv("Cleaned data/Cleaned_tuition_data.csv")
#head(tuition)

#create new column for year in tuition data 
tuition_year <- tuition %>%
    separate(col = Academic.Year,
            into = c("Year", "End_Year"),
            sep = "-")
head(tuition_year)

#convert Year in tuition into numeric 
tuition_year$Year <- as.numeric(tuition_year$Year)

```

```{r}
#convert the debt in billions of dollars into thousands to scale with tuition (in thousands)
# debt_convert <- clean_debtyear_drop %>%
#     mutate("Total_Debt_Outstanding_Thousands" = 1000000 * (Total_Dollars_Outstanding))
```

```{r}
#average out the Total_Debt_Outstanding_Thousands to scale with average tuition 
debt_avg_convert <- clean_debtyear_drop %>%
    group_by(Year) %>%
    summarize(Average_debt_outstanding = mean(Total_Dollars_Outstanding, na.rm = TRUE))
```

```{r}
#join the tuition and the debt data
tuition_debt_join <- left_join(tuition_year, debt_avg_convert, by = "Year")
#head(tuition_debt_join)
#names(tuition_debt_join)

#sort data for clean lines on plot
tuition_debt_join2 <- tuition_debt_join %>%
    arrange(Year, degree_granting)
```

# IPEDS Enrollment by demographic join

```{r}
#load the enrollment by demographics data 
enroll_dem <- read.csv("Cleaned data/Cleaned_ipeds_totals_summary_state_demographics.csv")
#names(enroll_dem)
#head(enroll_dem)

#create subset, only keep certain columns 
enroll_dem_subset <- enroll_dem[, c("state", "state_fips_code", "year", "trade_school_check", "Level.and.degree.certificate.seeking.status.of.student", "Undergraduate.or.graduate.level.of.student", "Grand.total", "Grand.total.men", "Grand.total.women")]

#rename year column 
enroll_dem_rename <- enroll_dem_subset %>%
    rename(Year = year)

#keep only trade school enrollment 
enroll_dem_trade <- enroll_dem_rename %>%
    filter(trade_school_check == 1)
```

```{r}
#summarize enrollment by year
enroll_summarize <- enroll_dem_trade %>%
    group_by(Year) %>%
    summarize(Average_enroll = mean(Grand.total, na.rm = TRUE))
```

```{r}
#join enroll summarize data with the join tuition and debt data 
tuition_debt_enroll <- left_join(tuition_debt_join2,enroll_summarize, by = "Year")
```

```{r}
#add 'tuition' to degree granting values for plot legend 
tuition_debt_enroll$degree_granting <- paste0(tuition_debt_enroll$degree_granting, " Tuition")

#set degree_granting as factor 
tuition_debt_enroll$degree_granting <- as.factor(tuition_debt_enroll$degree_granting)

```

# Visuals - Debt, tuition, and enrollment

```{r}
#create plotly line graph of debt amount, tuition, and enrollment
tuition_debt_enroll_fig <- plot_ly(tuition_debt_enroll,
              x =~Year, y = ~Average_enroll,  #average enrollment bars
              name = "Average Enrollment",
              type = "bar",
              text = ~paste("Year: ", Year, "<br>", "Average Enrollment: ", Average_enroll), hoverinfo = "text", textposition = "none", opacity = 0.4) %>%
add_trace(tuition_debt_enroll,  #average tuition lines
              x =~Year, y =~Average.Tuition...Feeds, 
              name = ~degree_granting,
              type = 'scatter',
              mode = 'lines+markers',
              split = ~degree_granting,
              color = ~degree_granting,
              text = ~paste("Year: ", Year, "<br>", "Tuition: ", Average.Tuition...Feeds), hoverinfo = "text", 
              textposition = "none", yaxis = "y2", opacity = 1) %>%
add_trace(tuition_debt_enroll, #average debts line
              x =~Year, y =~Average_debt_outstanding, 
                       name = "Average Debt",
                       type = 'scatter',
                       mode = 'lines+markers',
                       text = ~paste("Year: ", Year, "<br>", "Average Debt Amount: ", Average_debt_outstanding), hoverinfo = "text", textposition = "none", yaxis = "y2", opacity = 1) %>%
layout(title = "Average Tuition and Debt vs. Enrollment from 2017 to 2025", #add plot title and axis 
           barmode = "overlay",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Debt (in thousands)", tickprefix = "$"),
          yaxis2 = list(title = "Tuition (in thousands)",
                       overlaying = "y",
                       side = "right", tickprefix = "$"))

tuition_debt_enroll_fig
```

```{r}
#export plotly graph 
htmlwidgets::saveWidget(tuition_debt_enroll_fig, "EDA and Visuals/Tuition_debt_enrollment_plot.html")
```

# Statistical tests - Debt and tuition and enrollment

```{r}
#transform debt into factors: low and high debt to fit into model 
joined_debt_factor <- tuition_debt_enroll 

joined_debt_factor$Average_debt_factor <- ifelse(
    joined_debt_factor$Average_debt_outstanding < mean(joined_debt_factor$Average_debt_outstanding), "Low Debt", "High Debt")
    

#transform tuition into factors: low and high tuition to fit into mode
joined_tuition_factor <- joined_debt_factor 

joined_tuition_factor$Average_tuition_factor <- ifelse( 
    joined_tuition_factor$Average.Tuition...Feeds < mean(joined_tuition_factor$Average.Tuition...Feeds), "Low Tuition", "High Tuition")


```

```{r}
#convert to factor
joined_tuition_factor$Average_debt_factor <- as.factor(joined_tuition_factor$Average_debt_factor)

joined_tuition_factor$Average_tuition_factor <- as.factor(joined_tuition_factor$Average_tuition_factor)
```

```{r}
#create boxplot of debt and tuition 
library(ggplot2)

ggplot(joined_tuition_factor, aes(x= Average_tuition_factor, y = Average_enroll , fill = Average_debt_factor)) + 
geom_boxplot() +
labs(title = "Distribution of Debt and Tuition and Vocational School Enrollment",
    x = "Tuition",
    y = "Enrollment")

```

```{r}
library(patchwork)
#v2 boxplot 
b1 <- ggplot(joined_tuition_factor, aes(x= Average_tuition_factor, y = Average_enroll)) + 
geom_boxplot() +
labs(title = "Distribution of Tuition and Vocational School Enrollment",
    x = "Tuition",
    y = "Enrollment")

b2 <- ggplot(joined_tuition_factor, aes(x= Average_debt_factor, y = Average_enroll)) + 
geom_boxplot() +
labs(title = "Distribution of Debt and Vocational School Enrollment",
    x = "Debt amount",
    y = "Enrollment")

b1 + b2
```

```{r}
#save boxplot 
ggsave("EDA and Visuals/Debt_tuition_enroll_boxplot.png")
```

```{r}
#check assumptions for ANOVA normality and homogeneity of variance
#shapiro-wilk test for each group 
shapiro.test(joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_tuition_factor == "Low Tuition"])

shapiro.test(joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_tuition_factor == "High Tuition"])

shapiro.test(joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_debt_factor == "Low Debt"])

shapiro.test(joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_debt_factor == "High Debt"])
```

Shapiro-Wilk normality test

data: joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_tuition_factor == "Low Tuition"\] W = 0.78283, p-value = 0.0187

data: joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_tuition_factor == "High Tuition"\] W = 0.78283, p-value = 0.0187

data: joined_tuition_factor$Average_enroll[joined_tuition_factor$Average_debt_factor == "High Debt"\] W = 0.67701, p-value = 0.0005107

Shapiro shows less than 0.05, indicating no deviation from normality. Normality assumptions satisfied for all groups.

```{r}
#homogeneity of variance - Levene's test 
library(car)
leveneTest(Average_enroll ~ Average_tuition_factor, data = joined_tuition_factor)

leveneTest(Average_enroll ~ Average_debt_factor, data = joined_tuition_factor)
```

> leveneTest(Average_enroll \~ Average_tuition_factor, data = joined_tuition_factor) Levene's Test for Homogeneity of Variance (center = median) Df F value Pr(\>F) group 1 0 1 14
>
> leveneTest(Average_enroll \~ Average_debt_factor, data = joined_tuition_factor) Levene's Test for Homogeneity of Variance (center = median) Df F value Pr(\>F) group 1 2.5195 0.1348 14

Levene's test greater than 0.05 p-value. Fail to reject null hypothesis of equal variance. No evidence of unequal variances across the four groups of debts and tuitions. Variability in assignement scores appear to be similar for all combinations of debt and tuition, so equal-variance assumtoions for ANOVA is satisfied.

```{r}
#two way anova 
debt_tuition_enroll_fit <- aov(Average_enroll ~ Average_tuition_factor * Average_debt_factor, data = joined_tuition_factor)
summary(debt_tuition_enroll_fit)
```

Average_debt_factor 1.8e-06 \*\*\*

Null hypothesis: In terms of the effects of tuition - There is no difference in the average vocational school enrollment between low tuition and high tuition.

In terms of the effects of debt - There is no difference in average vocational school enrollment between low debt and high debt

In terms of the interaction - Tuition influence on enrollment does not depend on the debt level, and the debt level influence on enrollment does not depend on the tuition level.

```{r}
#post-hoc comparision tukey 
TukeyHSD(debt_tuition_enroll_fit)
```

High Tuition:High Debt showed higher enrollment than High Tuition:Low Debt with 2.2 difference unit. Same with Low Tuition:Low Debt-High Tuition:High Debt, High Tuition:Low Debt-Low Tuition:High Debt, Low Tuition:Low Debt-Low Tuition:High Debt.

High Tuition:Low Debt had lower enrollment that Low Tuition:Low Debt with difference -1.16 unit.

```{r}
#assumption checks 
par(mfrow = c(1,2))
plot(debt_tuition_enroll_fit, which = 1)    # Residuals vs Fitted (homoscedasticity)
plot(debt_tuition_enroll_fit, which = 2)    # Normal Q-Q (normality)
```

# Visuals - Loan and enrollment

```{r}
#summarize types of loans 
loan_summarize <- clean_loanyear_drop %>%
    group_by(Year) %>%
    summarize(Average_loan_outstanding = mean(Total_Dollars_Loan_Outstanding, na.rm = TRUE), Average_loan_recipients = mean(Total_Loan_Recipients, na.rm = TRUE))
```

```{r}
#load the enrollment by demographics including trade school and non trade schools 
enroll_trade_college <- read.csv("Cleaned data/Cleaned_ipeds_summary_state_demographics.csv")

#create subset, only keep certain columns 
enroll_trade_college_subset <- enroll_trade_college[, c("state", "state_fips_code", "year", "trade_school_check", "Level.and.degree.certificate.seeking.status.of.student", "Undergraduate.or.graduate.level.of.student", "Grand.total")]

#rename year column 
enroll_trade_college_rename <- enroll_trade_college_subset %>%
    rename(Year = year)
```

```{r}
#add 'enrollment' to undergrad and all student level column
enroll_trade_college_rename2 <- enroll_trade_college_rename 

enroll_trade_college_rename2$Undergraduate.or.graduate.level.of.student <- paste0(enroll_trade_college_rename2$Undergraduate.or.graduate.level.of.student, " Enrollment")

#set undergrad and all student level as factor
enroll_trade_college_rename2$Undergraduate.or.graduate.level.of.student <- as.factor(enroll_trade_college_rename2$Undergraduate.or.graduate.level.of.student)

#summarize enrollments by year and undergrad level factor
enroll_trade_college_summarize <- enroll_trade_college_rename2 %>%
    group_by(Year, Undergraduate.or.graduate.level.of.student) %>%
    summarize(Average_enroll = mean(Grand.total, na.rm = TRUE))

```

```{r}
#join with enrollment data with loan data 
loan_enroll_trade_college_join <- left_join(enroll_trade_college_summarize, loan_summarize,  by = "Year")

```

```{r}
#transform Year into numeric 
#loan_enroll_trade_college_join$Year <- as.numeric(as.character(loan_enroll_trade_college_join$Year))

#aggregate the data by year to remove the Undergraduate.or.graduate.level.of.student filter 
loan_enroll_trade_college_join2 <- loan_enroll_trade_college_join %>%
    group_by(Year) %>%
    summarize(Average_loan = mean(Average_loan_outstanding, na.rm = TRUE),
             Average_loan_number = mean(Average_loan_recipients, na.rm = TRUE),
             Average_enrollment = mean(Average_enroll, na.rm = TRUE),
             .groups = "drop")
```

```{r}
#create plotly line graph of loan amount and loan number with college vs. trade enrollment
loan_enroll_fig <- plot_ly(loan_enroll_trade_college_join,
              x =~Year, y = ~Average_enroll,  #average enrollment bars
              #name = ~Undergraduate.or.graduate.level.of.student,
              type = "bar",
              color =~Undergraduate.or.graduate.level.of.student,
              split =~Undergraduate.or.graduate.level.of.student,
                  text = ~paste("Year: ", Year, "<br>", "Average Enrollment: ", Average_enroll, "<br>", "Enrollment Group: ", Undergraduate.or.graduate.level.of.student), hoverinfo = "text", textposition = "none", opacity = 0.4) %>% add_trace(data = loan_enroll_trade_college_join2,  
              x =~Year, y =~Average_loan,
              name = "Average Loan Amount",
              #color = I("red"),
              inherit = FALSE,
              type = 'scatter',
              mode = 'lines+marker',
              text = ~paste("Year: ", Year, "<br>", "Loan Amount: ", Average_loan), hoverinfo = "text", 
              textposition = "none", opacity = 1) %>% add_trace(data = loan_enroll_trade_college_join2,  
              x =~Year, y =~Average_loan_number, 
              name = "Average Number of Loans",
              #color = I("orange"),
              inherit = FALSE,
              type = 'scatter',
              mode = 'lines+marker',
              text = ~paste("Year: ", Year, "<br>", "Number of Loans: ", Average_loan_number), hoverinfo = "text", 
              textposition = "none", yaxis = "y2", opacity = 1) %>% layout(title = "Average Loan Amount and Recipient \n and College vs. Trade Enrollment from 2014 to 2025", 
           barmode = "group",
          xaxis = list(title = "Year"),
          yaxis = list(title = "Tuition Amount (in thousands)"),
          yaxis2 = list(title = "Number of Loans",
                       overlaying = "y",
                       side = "right"))
loan_enroll_fig 
```

```{r}
#export plotly graph 
htmlwidgets::saveWidget(loan_enroll_fig , "EDA and Visuals/Loans_enrollment_plot.html")

```

# Statistical tests - loans and enrollment ANOVA

```{r}
#transform loan amount into factors: low and high loan to fit into model 
joined_loan_enroll_factor <- loan_enroll_trade_college_join

joined_loan_enroll_factor$Average_loan_factor <- ifelse(joined_loan_enroll_factor$Average_loan_outstanding < mean(joined_loan_enroll_factor$Average_loan_outstanding), "Low Loan Amount", "High Loan Amount")

#transform number of loans into factors: low and high loan count 
joined_loan_enroll_factor$Average_loan_number_factor <- ifelse(joined_loan_enroll_factor$Average_loan_recipients < mean(joined_loan_enroll_factor$Average_loan_recipients), "Low Loan Count", "High Loan Count")


```

```{r}
#convert to factors
joined_loan_enroll_factor$Average_loan_factor <- as.factor(joined_loan_enroll_factor$Average_loan_factor)

joined_loan_enroll_factor$Average_loan_number_factor <- as.factor(joined_loan_enroll_factor$Average_loan_number_factor)
```

```{r}
#create boxplot of loans and enrollment
ggplot(joined_loan_enroll_factor, aes(x= Average_loan_outstanding, y = Average_enroll , fill = Average_loan_recipients)) + 
geom_boxplot() +
labs(title = "Distribution of Loans and Enrollment",
    x = "Loan Amount",
    y = "Enrollment")

```

```{r}
#save boxplot 
ggsave("EDA and Visuals/Loan_enroll_boxplot.png")
```

```{r}
#create subset of trade school enrollment 
# loan_enroll_trade <- joined_loan_enroll_factor %>%
#     filter(Undergraduate.or.graduate.level.of.student == "All students total Enrollment")

# #create subset of undergrad enrollment 
# loan_enroll_college <- joined_loan_enroll_factor %>%
#     filter(Undergraduate.or.graduate.level.of.student == "Undergraduate Enrollment")

```

```{r}
#check assumptions for ANOVA normality and homogeneity of variance on trade school enroll subset
#shapiro-wilk test for each group 
shapiro.test(joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_outstanding == "Low Loan Amount"])

shapiro.test(joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_outstanding == "High Loan Amount"])

shapiro.test(joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_recipients == "Low Loan Count"])

shapiro.test(joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_recipients == "High Loan Count"])
```

data: joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_outstanding == "Low Loan Amount"\] W = 0.78708, p-value = 0.08099

data: joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_outstanding == "High Loan Amount"\] W = 0.72916, p-value = 0.01236

data: joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_recipients == "Low Loan Count"\] W = 0.78708, p-value = 0.08099

data: joined_loan_enroll_factor$Average_enroll[joined_loan_enroll_factor$Average_loan_recipients == "High Loan Count"\] W = 0.72916, p-value = 0.01236

Shapiro shows greater than 0.05 for low loan amount and low loan count, indicating there is deviation from normality. Normality assumptions not satisfied for all groups.

```{r}
#homogeneity of variance - Levene's test 
leveneTest(Average_enroll ~ Average_loan_outstanding, data = joined_loan_enroll_factor)

leveneTest(Average_enroll ~ Average_loan_recipients, data = joined_loan_enroll_factor)
```

leveneTest(Average_enroll \~ Average_loan_recipientLevene's Test for Homogeneity of Variance (center = median) Df F value Pr(\>F) group 1 0.0174 0.8982 8\
s, data = joined_loan_enroll_factor)

> leveneTest(Average_enroll \~ Average_loan_recipients, data = joined_loan_enroll_factor) Levene's Test for Homogeneity of Variance (center = median) Df F value Pr(\>F) group 1 0.0174 0.8982 8

Levene's test greater than 0.05 p-value. Fail to reject null hypothesis of equal variance. No evidence of unequal variances across the four groups of loan amounts and number of loan levels. Variability in enrollment appear to be similar for all combinations of loan amount and number of loans, so equal-variance assumptions for ANOVA is satisfied.

```{r}
#two way anova 
loan_enroll_fit <- aov(Average_enroll ~ Average_loan_outstanding + Average_loan_recipients + (Average_loan_outstanding * Average_loan_recipients), data = joined_loan_enroll_factor)
summary(loan_enroll_fit)
```

Average_loan_outstanding 1 1.214e+08 1.214e+08 0.024 Average_loan_recipients 1 1.956e+07 1.956e+07 0.004 Average_loan_outstanding:Average_loan_recipients 1 4.100e+07 4.100e+07 0.008 Residuals 6 3.047e+10 5.078e+09\
Pr(\>F) Average_loan_outstanding 0.882 Average_loan_recipients 0.953 Average_loan_outstanding:Average_loan_recipients 0.931

Neither loan amount or number of loans were significant predictors for enrollment. Fail to reject the null hypothesis.

# Heatmap by debt and enrollment in trade schools

```{r}
#clean up debt data, keep only year, quarter, total dollars outstanding, and total dollars borrowed fields 
# clean_debt2 <- clean_debtyear_drop %>%
#     group_by(Year) %>%
#     summarize(Avg_Debt_Amount = mean(Total_Dollars_Outstanding, na.rm = TRUE),
#              Avg_Debt_Borrowed = mean(Total_Dollars_Borrowers, na.rm = TRUE))
```

```{r}
#load enrollment data
ipeds_state_summary_2024 <- read.csv("Cleaned data/Cleaned_ipeds_summary_2024_state_demographics.csv")
#ipeds_state_summary <- read.csv("Cleaned data/Cleaned_ipeds_summary_state_demographics.csv")
debt_state <- read.csv("Cleaned data/Cleaned_debt_by_location.csv")
```

```{r}
#names(debt_state)
#summarize debt amount to get total and summarize debt borrowers to get total 
debt_state_sum <- debt_state %>%
    mutate(Total_Debt_Amount = rowSums(across(c("Less_than_5k_Dollars_Outstanding_.in.billions.", "X5k_to_10K_Dollars_Outstanding_.in.billions.", "X10k_to_20K_Dollars_Outstanding_.in.billions.", "X20k_to_40K_Dollars_Outstanding_.in.billions.", "X40k_to_60K_Dollars_Outstanding_.in.billions.", "X60k_to_80K_Dollars_Outstanding_.in.billions.", "X80k_to_100K_Dollars_Outstanding_.in.billions.", "X100k_to_200K_Dollars_Outstanding_.in.billions.", "X200K_plus_Dollars_Outstanding_.in.billions."))))

debt_state_sum2 <- debt_state_sum %>%
    mutate(Total_Debt_Borrowers = rowSums(across(c("Less_than_5k_Borrowers_.in.thousands.", "X5k_to_10k_Borrowers_.in.thousands.", "X10k_to_20k_Borrowers_.in.thousands.", "X20k_to_40k_Borrowers_.in.thousands.", "X40k_to_60k_Borrowers_.in.thousands." , "X60k_to_80k_Borrowers_.in.thousands." , "X80k_to_100k_Borrowers_.in.thousands.", "X100k_to_200k_Borrowers_.in.thousands.", "X200k_plus_Borrowers_.in.thousands."))))

#rename state
debt_state_sum2 <- debt_state_sum2 %>%
    rename(state = States)
```

```{r}
## Heat map: debt amount by state

library(tidyverse)

# Isolate the state and count of students for trade schools vs not
state_counts_wide <- ipeds_state_summary_2024 |>
  select(state, state_fips_code, trade_school_check, Grand.total)

state_counts_wide$Grand.total <- as.numeric(state_counts_wide$Grand.total)

# Pivot wider so trade school counts both get their own columns
state_counts_wide <- state_counts_wide |>
  pivot_wider(
    names_from = trade_school_check,
    values_from = Grand.total,
    names_prefix = "trade_school_"
  ) 

# Convert NA to 0 (so addition doesn't break)
state_counts_wide <- state_counts_wide |>
  mutate(
    trade_school_False = ifelse(is.na(trade_school_False), 0, trade_school_False),
    trade_school_True  = ifelse(is.na(trade_school_True), 0, trade_school_True)
  )

# Add a combined total column
state_counts_wide <- state_counts_wide |>
  mutate(total_students_combined = trade_school_False + trade_school_True)

# Add a percentage of total in trade school and traditional 4-year schools
state_counts_wide <- state_counts_wide |>
  mutate(
    percent_trade_school = (trade_school_True /total_students_combined) * 100,
    percent_traditional_school = (trade_school_False / total_students_combined) * 100
  )

# Drop US territories and Washington DC (50 state map scope)
state_counts_wide <- state_counts_wide |> filter( !state %in% c("American Samoa", "Marshall Islands", "Northern Marianas", "Virgin Islands", "Guam", "Micronesia", "Palau", "Puerto Rico", "District of Columbia"))

# Get the lat/long values for the middle of each state
state_coord_lookup <- data.frame(
  state = state.name,
  lon = state.center$x,
  lat = state.center$y
)

# Merge coordinates into trade school data
label_data <- state_counts_wide |>
  left_join(state_coord_lookup, by = "state")

# Make offsets for the labels of small states so they don't overlap
offsets <- tribble(
  ~state, ~lon_offset, ~lat_offset,
  "Connecticut",     0.2,   -0.3,  # 1.2, -0.3
  "Rhode Island",    1.4,    0.3,
  "Massachusetts",   1.2,    0.6,
  "New Jersey",      1.0,   -0.5,
  "Delaware",        1.0,   -0.2,
  "Maryland",        0.8,   -0.3,
  "Vermont",         0.6,    0.5,
  "New Hampshire",   0.8,    0.8,
  "Hawaii",         24.0,   -5.3,
  "Alaska",         11.5,  -22.0,
)

label_data <- label_data |>
  left_join(offsets, by = "state") |>
  mutate(
    lon_plot = ifelse(is.na(lon_offset), lon, lon + lon_offset),
    lat_plot = ifelse(is.na(lat_offset), lat, lat + lat_offset)
  )

#join enrollment with debt data on state
enrollment_debt_map <- left_join(enroll_rename_year, debt_state_sum2, by = "state")
```

```{r}
# Create the heatmap
debt_enroll_map_fig <- plot_ly() |>
  add_trace(
    data = enrollment_debt_map, #state_counts_wide_2024,
    type = "choropleth",
    locations = ~state_fips_code,
    z = ~Total_Debt_Amount, #~percent_trade_school,
    locationmode = "USA-states",
    colorscale = "Plasma",
    colorbar = list(title = "Debt amount (in billions)"),
    text = ~paste(
      "State: ", state, "<br>",
      "Total Debt Amount (in billions): ", Total_Debt_Amount, "<br>",
      "Total Debt Borrowed (in thousands): ", Total_Debt_Borrowers, "<br>",
      "Trade School %: ", round(percent_trade_school, 2), "%<br>",
      "Total Students: ", total_students_combined
    ),
    hoverinfo = "text"
  ) |>
  add_trace(
    data = label_data,
    type = "scattergeo",
    mode = "text",
    lon = ~lon_plot,
    lat = ~lat_plot,
    #text = ~paste0(round(percent_trade_school), "%"),
    #text = ~paste0(round(Avg_Debt_Amount)),
    #textfont = list(size = 11, color = "black"),
    hoverinfo = "none",
    showlegend = FALSE
  ) |>
  layout(
    geo = list(
      scope = "usa",
      projection = list(type = "albers usa"),
      showlakes = TRUE,
      lakecolor = "lightblue"
    ),
    title = list(
      text = "Debt Amount and Percentage of Students Attending Trade Schools by State",
      y = 0.97,
      yanchor = "top"
    )
  )

debt_enroll_map_fig
```

```{r}
htmlwidgets::saveWidget(debt_enroll_map_fig, "EDA and Visuals/Complete Visuals/Debt_enroll_heatmap.html", selfcontained=TRUE)

```